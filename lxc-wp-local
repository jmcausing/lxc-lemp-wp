#### LXC + LEMP + WordPress by generator by John Mark C.
#
# LXD verson is good. 4.0.2. Let's proceed!
# Hello! Enter the LXC container name please:
# Enter LXC name: WP
# Alright! Let's generate the LXC container Ubuntu 18.04: WP
#
#
# Make sure you run this from your local laptop/machine FIRST
# ssh-keygen -f ~/.ssh/WP
# Are you done generating SSH key? Paste the public key here of WP.pub
# Enter PUBLIC KEY WP.pub : ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQCVByq0lDRHrJ8XtX/eZXbRUqXOfWld4ypDEKwAovb+TYoT/TYeHavzx2CEyiA++yZfPfF0n8kE8uB9N+Z1PeX9DTB2Mmd/TQnrBXxLTv5ByJPHeTkUjjU7xIgxzQxup7xDCoo3r6t+5YwIZThIUGC5R9Oix0/fCkOeHdN4PkTQEyrsWD1VX3YLbsSqK/v0H2AUhq3Zufcg5n10pZ3iWj0AoV0GE/ugtxIZUjk1+mQArfVY50K3I8+iNcX4tWwJMKqTen660qZyGpSKv5pcSA5ojvl+DpdqgwBczEJfNPMMXHhObqVqm4V1JGOnBRZZNxGLD1u7q9sZob3fysyIOGtkYOkE8nmyH+Ec+OGBoTcZwMAKr8znKhqO3ENcJrFs4CWERKKUmZAM/FWprl1VVqnVACztcQYI4Ld3iq42CmKupfYiAUKGyQtlm0Vy4kP+Qvv1YunA/kr014qIi2aSW+6jmk9Q6UK2+NqdEDzrvG9ijvkTh7W4lwXSyqVLoy05mxU= johnmarkcausing@Johns-MacBook-Pro.local
# Let's update.. (apt install update)
#
All packages are up to date.
# Checking required apps..
# jq is here..
# Ansible is here..
# Checking for apt update and upgrades..

WARNING: apt does not have a stable CLI interface. Use with caution in scripts.

# No upgrades needed..
# LXD is already configured. Let's proceed.
Creating WP
Starting WP                                
#
# Let's generate SSH-KEY gen for this LXC
#
Generating public/private rsa key pair.
Your identification has been saved in /home/ubuntu/.ssh/id_lxc_WP
Your public key has been saved in /home/ubuntu/.ssh/id_lxc_WP.pub
The key fingerprint is:
SHA256:Qtvsz8CoHH7/HOdwaFNyV83xffr62s4ryJBwXVKZngM key for local LXC
The key's randomart image is:
+---[RSA 3072]----+
|            ..o. |
|           E + .=|
|      .   . = . B|
|     . = . . + o.|
|      o S o o +  |
|       = o = . . |
|    . . + O +   .|
|   o o.  * X . + |
|    +. ...= . +=*|
+----[SHA256]-----+
#
# - START - Details from ssh key gen
#
#
# START - Info of LXC: WP
#
# Trying to get the LXC IP Address..
/
# IP Address found!  WP LXC IP: 10.149.35.128
# 
# Checking status of LXC list again..
+------+---------+----------------------+-----------------------------------------------+-----------+-----------+
| NAME |  STATE  |         IPV4         |                     IPV6                      |   TYPE    | SNAPSHOTS |
+------+---------+----------------------+-----------------------------------------------+-----------+-----------+
| WP   | RUNNING | 10.149.35.128 (eth0) | fd42:7afb:acff:8bcc:216:3eff:fedc:a083 (eth0) | CONTAINER | 0         |
+------+---------+----------------------+-----------------------------------------------+-----------+-----------+
# Sending public key to target LXC:  WP
#
######## lxc file push /home/ubuntu/.ssh/id_lxc_WP.pub WP/root/.ssh/authorized_keys --verbose
INFO[08-26|20:35:25] Pushing /var/lib/snapd/hostfs/home/ubuntu/.ssh/id_lxc_WP.pub to /root/.ssh/authorized_keys (file) 
#                                                                                                            
# Fixing root permission for authorized_keys file
#
mode of '/root/.ssh/authorized_keys' changed from 0644 (rw-r--r--) to 0600 (rw-------)
changed ownership of '/root/.ssh/authorized_keys' from ubuntu:ubuntu to root:root
#
# Adding SSH-key for this host so we can SSH to the target LXC.
#
Agent pid 124189
Identity added: /home/ubuntu/.ssh/id_lxc_WP (key for local LXC)
#
# Adding local machine puiblic key to LXC
# Done! Ready to connect?
#
# Connect to this: ssh -i ~/.ssh/id_lxc_WP root@10.149.35.128
#
#
#
# default does not exist.
# Downloading a fresh nginx default config file
#
#
# vars.yml does not exist.
# Downloading a fresh nginx default config file
#
#
ansible_wpconfig.php does not exist.
# Downloading a fresh nginx default config file
#
#
play.yml does not exist.
# Downloading a fresh nginx default config file
#
# Checking files..
-rw-rw-r-- 1 ubuntu ubuntu 5261 Aug 26 20:35 WP_lemp.yml
-rw-rw-r-- 1 ubuntu ubuntu 42 Aug 26 20:35 WP_hosts
-rw-rw-r-- 1 ubuntu ubuntu 260 Aug 26 20:35 vars.yml
#
#
# Running playbook with this command:
#
# ANSIBLE_HOST_KEY_CHECKING=False ansible-playbook WP_lemp.yml -i WP_hosts --private-key=/home/ubuntu/.ssh/id_lxc_WP
#

PLAY [all] *************************************************************************************************************

TASK [Gathering Facts] *************************************************************************************************
ok: [10.149.35.128]

TASK [sudo add-apt-repository ppa:ondrej/ph] ***************************************************************************
[WARNING]: Consider using 'become', 'become_method', and 'become_user' rather than running sudo
changed: [10.149.35.128]

TASK [Apt Update] ******************************************************************************************************
[WARNING]: Consider using the apt module rather than running 'apt-get'.  If you need to use command because apt is
insufficient you can add 'warn: false' to this command task or set 'command_warnings=False' in ansible.cfg to get rid
of this message.
changed: [10.149.35.128]

TASK [Install LEMP Packages [nginx, mysq-server, python3-pymysql']] ****************************************************
changed: [10.149.35.128] => (item=nginx)
changed: [10.149.35.128] => (item=mariadb-server)
changed: [10.149.35.128] => (item=python3-mysqldb)

TASK [Sets the root password] ******************************************************************************************
[WARNING]: Module did not set no_log for update_password
changed: [10.149.35.128]

TASK [Create a new database with name 'wordpress'] *********************************************************************
changed: [10.149.35.128]

TASK [Create database user with password and all database privileges and 'WITH GRANT OPTION'] **************************
[WARNING]: Module did not set no_log for update_********
changed: [10.149.35.128]

TASK [Flush Privileges] ************************************************************************************************
changed: [10.149.35.128]

TASK [Installing PHP 7.3 extension] ************************************************************************************
changed: [10.149.35.128] => (item=php7.3-fpm)
ok: [10.149.35.128] => (item=php7.3-common)
changed: [10.149.35.128] => (item=php7.3-mysql)
changed: [10.149.35.128] => (item=php7.3-curl)
ok: [10.149.35.128] => (item=php7.3-json)
changed: [10.149.35.128] => (item=php7.3-mbstring)
changed: [10.149.35.128] => (item=php7.3-xml)
changed: [10.149.35.128] => (item=php7.3-zip)
changed: [10.149.35.128] => (item=php7.3-gd)
changed: [10.149.35.128] => (item=php7.3-soap)
changed: [10.149.35.128] => (item=php7.3-ssh2)
ok: [10.149.35.128] => (item=php7.3-tokenizer)

TASK [Sets / copy Nginx conf file] *************************************************************************************
changed: [10.149.35.128]

TASK [Test and reload Nginx] *******************************************************************************************
changed: [10.149.35.128]

TASK [Download and unpack latest WordPress] ****************************************************************************
changed: [10.149.35.128]

TASK [Remove old html and replace with with WP files] ******************************************************************
[WARNING]: Consider using the file module with state=absent rather than running 'rm'.  If you need to use command
because file is insufficient you can add 'warn: false' to this command task or set 'command_warnings=False' in
ansible.cfg to get rid of this message.
changed: [10.149.35.128]

TASK [Set ownership] ***************************************************************************************************
changed: [10.149.35.128]

TASK [Set permissions for directories] *********************************************************************************
changed: [10.149.35.128]

TASK [Set permissions for files] ***************************************************************************************
changed: [10.149.35.128]

TASK [Set up wp-config] ************************************************************************************************
changed: [10.149.35.128]

TASK [set PHP memory limit] ********************************************************************************************
changed: [10.149.35.128]

TASK [set PHP post_max_size] *******************************************************************************************
changed: [10.149.35.128]

TASK [set PHP upload_max_filesize] *************************************************************************************
changed: [10.149.35.128]

TASK [set PHP max_execution_time] **************************************************************************************
[WARNING]: The value 300 (type int) in a string field was converted to '300' (type string). If this does not look like
what you expect, quote the entire value to ensure it does not change.
changed: [10.149.35.128]

TASK [Restart PHP FPM] *************************************************************************************************
changed: [10.149.35.128]

PLAY RECAP *************************************************************************************************************
10.149.35.128              : ok=22   changed=21   unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   


real    2m52.088s
user    0m23.395s
sys     0m10.538s
Device webport8913 added to WP
Device sshport2917 added to WP
#
#
# Insert nginx config client_max_body_size 100M;
#
#
# Test and reload nginx;
nginx: the configuration file /etc/nginx/nginx.conf syntax is ok
nginx: configuration file /etc/nginx/nginx.conf test is successful
#
#
# Connecto to your local site using this http://192.168.64.4:8913
# Connect to this: ssh -i ~/.ssh/WP -p 2917 root@192.168.64.4
#
#
#
# Add this also to your ssh config file (like if you are using Visual Code Studio for remote SSH)
Host WP
    User root
   Hostname 192.168.64.4
   Port 2917
   PreferredAuthentications publickey
   IdentityFile ~/.ssh/WP
#
#
# Thank you for using LXC LEMP + WordPress setup!
ubuntu@primary:~$ 
